<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script src="js/config.js"></script>
    <script src="js/stimuli.js"></script>
    <script src="js/utils.js"></script>
</head>
<body></body>
<script>
// ── Set page title from config ───────────────────────────
document.title = CONFIG.PAGE_TITLE;

// ── Initialize jsPsych ───────────────────────────────────
var jsPsych = initJsPsych({
    show_progress_bar: true,
    auto_update_progress_bar: false,
    on_data_update: function() {
        jsPsych.data.addProperties({worker_id: urlvar.workerId});
    },
    max_load_time: CONFIG.MAX_LOAD_TIME_MS,
    on_finish: function(data){
        var completionLink = CONFIG.SONA_BASE_URL +
            "?experiment_id=" + CONFIG.SONA_EXPERIMENT_ID +
            "&credit_token=" + CONFIG.SONA_CREDIT_TOKEN +
            "&survey_code=" + sona_id;
        window.location.assign(completionLink);
    }
});

// ── Setup variables ──────────────────────────────────────
var timeline = [];
var secret_code = jsPsych.randomization.randomID(8);
var filename = CONFIG.FILENAME_PREFIX + "_" + secret_code + ".csv";
var urlvar = jsPsych.data.urlVariables();
var sona_id = urlvar.workerId;
var completed_main_trials = 0;
var useKeyboard = CONFIG.RESPONSE_MODE === "keyboard";

// ── Save data configuration ─────────────────────────────
var save_data = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: CONFIG.EXPERIMENT_ID,
  filename: filename,
  data_string: function() { return jsPsych.data.get().csv(); }
};

// ── Preload images ──────────────────────────────────────
timeline.push({
    type: jsPsychPreload,
    auto_preload: true,
    images: IMAGE_PATHS,
    show_progress_bar: true,
    message: CONFIG.PRELOAD_MESSAGE
});

// ── Welcome ─────────────────────────────────────────────
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: CONFIG.WELCOME_TEXT
});

// ── Fullscreen ──────────────────────────────────────────
timeline.push({
  type: jsPsychFullscreen,
  fullscreen_mode: true
});

// ── Consent ─────────────────────────────────────────────
timeline.push({
    type: jsPsychImageButtonResponse,
    stimulus: CONFIG.CONSENT_IMAGE_PATH,
    choices: [CONFIG.CONSENT_BUTTON_TEXT]
});

// ── Instructions ────────────────────────────────────────
var instructionsText = CONFIG.INSTRUCTIONS_HTML
    .replace("{{N_MAIN_TRIALS}}", CONFIG.N_MAIN_TRIALS);

timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: instructionsText,
  choices: [CONFIG.CONTINUE_BUTTON_TEXT],
  post_trial_gap: CONFIG.POST_INSTRUCTION_GAP_MS
});

// ── jsPsych sampling wrapper ────────────────────────────
var sampleFn = function(arr, n) {
    return jsPsych.randomization.sampleWithoutReplacement(arr, n);
};

// ── Build main trial (button or keyboard) ───────────────
var createTrial;

if (useKeyboard) {
    // Keyboard mode: show target + two choices as HTML, respond with keys
    createTrial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            var target = jsPsych.timelineVariable('stimulus');
            var left = jsPsych.timelineVariable('choice1');
            var right = jsPsych.timelineVariable('choice2');
            return '<div style="text-align:center;">' +
                '<div><img src="' + target + '" style="max-height:300px;"></div>' +
                '<div style="display:flex;justify-content:center;gap:40px;margin-top:20px;">' +
                '<div><img src="' + left + '" style="max-height:200px;"><br><b>' + CONFIG.RESPONSE_KEYS[0] + '</b></div>' +
                '<div><img src="' + right + '" style="max-height:200px;"><br><b>' + CONFIG.RESPONSE_KEYS[1] + '</b></div>' +
                '</div></div>';
        },
        choices: CONFIG.RESPONSE_KEYS,
        on_finish: function(data) {
            var trialType = jsPsych.timelineVariable('type');
            data.trial_type = trialType;
            // Map key press to choice index (0 = left, 1 = right)
            data.response = CONFIG.RESPONSE_KEYS.indexOf(data.response);
            data.speedy = data.rt < CONFIG.MIN_RT_MS;
            data.choices = [jsPsych.timelineVariable('choice1'), jsPsych.timelineVariable('choice2')];

            if (trialType === 'check') {
                data.correct = data.response === jsPsych.timelineVariable('correct_choice');
            }

            completed_main_trials++;
            jsPsych.setProgressBar(completed_main_trials / CONFIG.N_MAIN_TRIALS);
        }
    };
} else {
    // Button mode (default)
    createTrial = {
        type: jsPsychImageButtonResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: function() {
            return [
                jsPsych.timelineVariable('choice1'),
                jsPsych.timelineVariable('choice2')
            ];
        },
        button_html: '<button class="jspsych-btn"><img src=%choice%></button>',
        on_finish: function(data) {
            var trialType = jsPsych.timelineVariable('type');
            data.trial_type = trialType;
            data.speedy = data.rt < CONFIG.MIN_RT_MS;
            data.choices = [jsPsych.timelineVariable('choice1'), jsPsych.timelineVariable('choice2')];

            if (trialType === 'check') {
                data.correct = data.response === jsPsych.timelineVariable('correct_choice');
            }

            completed_main_trials++;
            jsPsych.setProgressBar(completed_main_trials / CONFIG.N_MAIN_TRIALS);
        }
    };
}

// ── Feedback screens ────────────────────────────────────
var speedFeedback = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: CONFIG.SPEED_FEEDBACK_HTML,
    choices: [CONFIG.FEEDBACK_CONTINUE_KEY]
};

var checkFeedback = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: CONFIG.CHECK_FEEDBACK_HTML,
    choices: [CONFIG.FEEDBACK_CONTINUE_KEY]
};

// ── Main procedure ──────────────────────────────────────
timeline.push({
    timeline: [
        {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: CONFIG.FIXATION_SYMBOL,
            choices: "NO_KEYS",
            trial_duration: CONFIG.FIXATION_DURATION_MS
        },
        createTrial,
        {
            timeline: [checkFeedback],
            conditional_function: function() {
                var lastTrial = jsPsych.data.get().last(1).values()[0];
                return lastTrial.trial_type === 'check' && !lastTrial.correct;
            }
        },
        {
            timeline: [speedFeedback],
            conditional_function: function() {
                var lastTrial = jsPsych.data.get().last(1).values()[0];
                return lastTrial.rt < CONFIG.MIN_RT_MS && lastTrial.trial_type !== 'check';
            }
        }
    ],
    timeline_variables: createTrialSequence(
        CONFIG.N_RANDOM_TRIALS,
        CONFIG.N_CHECK_TRIALS,
        CONFIG.N_VALIDATION_TRIALS,
        IMAGE_PATHS,
        VALIDATION_TRIALS,
        sampleFn
    ),
    randomize_order: false,
    on_timeline_start: function() {
        jsPsych.setProgressBar(0);
    }
});

// ── Demographics ────────────────────────────────────────
timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: CONFIG.DEMOGRAPHIC_INSTRUCTIONS_HTML,
    choices: [CONFIG.CONTINUE_BUTTON_TEXT],
    post_trial_gap: CONFIG.POST_DEMOGRAPHIC_GAP_MS
});

timeline.push({
    type: jsPsychSurveyMultiSelect,
    questions: [{
        prompt: CONFIG.RACE_ETHNICITY_PROMPT,
        options: CONFIG.RACE_ETHNICITY_OPTIONS,
        horizontal: false,
        required: true,
        name: 'race_eth'
    }]
});

timeline.push({
    type: jsPsychSurveyText,
    questions: [
        {prompt: CONFIG.AGE_PROMPT, rows: 1, columns: CONFIG.AGE_COLUMNS, name: "age", required: true},
        {prompt: CONFIG.GENDER_PROMPT, rows: 1, columns: CONFIG.GENDER_COLUMNS, name: "gender"}
    ]
});

// ── Save data ───────────────────────────────────────────
timeline.push(save_data);

// ── Goodbye ─────────────────────────────────────────────
timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
        var output = CONFIG.GOODBYE_HTML;
        if (urlvar.workerId.length > CONFIG.WORKER_ID_MIN_LENGTH) {
            output = output + CONFIG.SECRET_CODE_HTML
                .replace("{{SECRET_CODE}}", CONFIG.SECRET_CODE);
        }
        return output;
    },
    choices: [CONFIG.COMPLETE_BUTTON_TEXT]
});

// ── Run ─────────────────────────────────────────────────
jsPsych.run(timeline);
</script>
</html>
